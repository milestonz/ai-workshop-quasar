<template>
  <q-page class="q-pa-md">
    <div class="row q-col-gutter-md">
      <!-- Ìó§Îçî -->
      <div class="col-12">
        <div class="text-h4 q-mb-md">üìä ÏÑ§Î¨∏ Í≤∞Í≥º Í¥ÄÎ¶¨</div>
        <q-separator class="q-mb-lg" />
      </div>

      <!-- ÌÜµÍ≥Ñ Ïπ¥Îìú -->
      <div class="col-12">
        <div class="row q-col-gutter-md">
          <div class="col-md-3 col-sm-6">
            <q-card class="bg-primary text-white">
              <q-card-section>
                <div class="text-h6">{{ statistics.total || 0 }}</div>
                <div class="text-subtitle2">Ï¥ù ÏÑ§Î¨∏ Ïàò</div>
              </q-card-section>
            </q-card>
          </div>
          <div class="col-md-3 col-sm-6">
            <q-card class="bg-positive text-white">
              <q-card-section>
                <div class="text-h6">{{ averageSatisfaction }}%</div>
                <div class="text-subtitle2">ÌèâÍ∑† ÎßåÏ°±ÎèÑ</div>
              </q-card-section>
            </q-card>
          </div>
          <div class="col-md-3 col-sm-6">
            <q-card class="bg-info text-white">
              <q-card-section>
                <div class="text-h6">{{ averageRecommendation }}%</div>
                <div class="text-subtitle2">ÌèâÍ∑† Ï∂îÏ≤úÎèÑ</div>
              </q-card-section>
            </q-card>
          </div>
          <div class="col-md-3 col-sm-6">
            <q-card class="bg-warning text-white">
              <q-card-section>
                <div class="text-h6">{{ statistics.averageFeedbackLength || 0 }}</div>
                <div class="text-subtitle2">ÌèâÍ∑† ÌîºÎìúÎ∞± Í∏∏Ïù¥</div>
              </q-card-section>
            </q-card>
          </div>
        </div>
      </div>

      <!-- Ï∞®Ìä∏ ÏÑπÏÖò -->
      <div class="col-12">
        <q-card>
          <q-card-section>
            <div class="text-h6">üìà ÏÑ§Î¨∏ ÌÜµÍ≥Ñ</div>
          </q-card-section>
          <q-card-section>
            <div class="row q-col-gutter-md">
              <!-- ÎßåÏ°±ÎèÑ Ï∞®Ìä∏ -->
              <div class="col-md-4">
                <h6 class="q-mb-md">Í∞ïÏùò ÎßåÏ°±ÎèÑ</h6>
                <div v-for="(count, key) in statistics.satisfaction" :key="key" class="q-mb-sm">
                  <div class="row items-center">
                    <div class="col-6">
                      <span class="text-caption">{{ getSatisfactionLabel(key) }}</span>
                    </div>
                    <div class="col-4">
                      <q-linear-progress
                        :value="count / totalSurveys"
                        color="primary"
                        class="q-mr-sm"
                      />
                    </div>
                    <div class="col-2 text-right">
                      <span class="text-caption">{{ count }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Ï∂îÏ≤ú ÏùòÌñ• Ï∞®Ìä∏ -->
              <div class="col-md-4">
                <h6 class="q-mb-md">Ï∂îÏ≤ú ÏùòÌñ•</h6>
                <div v-for="(count, key) in statistics.recommendation" :key="key" class="q-mb-sm">
                  <div class="row items-center">
                    <div class="col-6">
                      <span class="text-caption">{{ getRecommendationLabel(key) }}</span>
                    </div>
                    <div class="col-4">
                      <q-linear-progress
                        :value="count / totalSurveys"
                        color="positive"
                        class="q-mr-sm"
                      />
                    </div>
                    <div class="col-2 text-right">
                      <span class="text-caption">{{ count }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Ï∂îÍ∞Ä ÍµêÏú° ÏùòÌñ• Ï∞®Ìä∏ -->
              <div class="col-md-4">
                <h6 class="q-mb-md">Ï∂îÍ∞Ä ÍµêÏú° ÏùòÌñ•</h6>
                <div
                  v-for="(count, key) in statistics.additionalEducation"
                  :key="key"
                  class="q-mb-sm"
                >
                  <div class="row items-center">
                    <div class="col-6">
                      <span class="text-caption">{{ getEducationLabel(key) }}</span>
                    </div>
                    <div class="col-4">
                      <q-linear-progress
                        :value="count / totalSurveys"
                        color="info"
                        class="q-mr-sm"
                      />
                    </div>
                    <div class="col-2 text-right">
                      <span class="text-caption">{{ count }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </q-card-section>
        </q-card>
      </div>

      <!-- ÏÑ§Î¨∏ Í≤∞Í≥º Î™©Î°ù -->
      <div class="col-12">
        <q-card>
          <q-card-section>
            <div class="row items-center justify-between">
              <div class="text-h6">üìã ÏÑ§Î¨∏ Í≤∞Í≥º Î™©Î°ù</div>
              <q-btn
                icon="refresh"
                label="ÏÉàÎ°úÍ≥†Ïπ®"
                color="primary"
                @click="loadSurveyResults"
                :loading="loading"
              />
            </div>
          </q-card-section>
          <q-card-section>
            <q-table
              :rows="surveyResults"
              :columns="columns"
              row-key="id"
              :loading="loading"
              :pagination="{ rowsPerPage: 10 }"
              flat
              bordered
            >
              <!-- ÎßåÏ°±ÎèÑ Ïª¨Îüº -->
              <template #body-cell-satisfaction="props">
                <q-td :props="props">
                  <q-chip :color="getSatisfactionColor(props.value)" text-color="white" size="sm">
                    {{ getSatisfactionLabel(props.value) }}
                  </q-chip>
                </q-td>
              </template>

              <!-- Ï∂îÏ≤ú ÏùòÌñ• Ïª¨Îüº -->
              <template #body-cell-recommendation="props">
                <q-td :props="props">
                  <q-chip :color="getRecommendationColor(props.value)" text-color="white" size="sm">
                    {{ getRecommendationLabel(props.value) }}
                  </q-chip>
                </q-td>
              </template>

              <!-- Ï∂îÍ∞Ä ÍµêÏú° ÏùòÌñ• Ïª¨Îüº -->
              <template #body-cell-additionalEducation="props">
                <q-td :props="props">
                  <q-chip :color="getEducationColor(props.value)" text-color="white" size="sm">
                    {{ getEducationLabel(props.value) }}
                  </q-chip>
                </q-td>
              </template>

              <!-- ÌîºÎìúÎ∞± Ïª¨Îüº -->
              <template #body-cell-feedback="props">
                <q-td :props="props">
                  <div v-if="props.value" class="text-caption">
                    {{
                      props.value.length > 50 ? props.value.substring(0, 50) + '...' : props.value
                    }}
                  </div>
                  <div v-else class="text-grey-5 text-caption">-</div>
                </q-td>
              </template>

              <!-- Ï†úÏ∂úÏùº Ïª¨Îüº -->
              <template #body-cell-submittedAt="props">
                <q-td :props="props">
                  {{ formatDate(props.value) }}
                </q-td>
              </template>

              <!-- ÏÉÅÏÑ∏Î≥¥Í∏∞ Ïª¨Îüº -->
              <template #body-cell-actions="props">
                <q-td :props="props">
                  <q-btn
                    flat
                    round
                    size="sm"
                    icon="visibility"
                    color="primary"
                    @click="showSurveyDetail(props.row)"
                  >
                    <q-tooltip>ÏÉÅÏÑ∏Î≥¥Í∏∞</q-tooltip>
                  </q-btn>
                </q-td>
              </template>
            </q-table>
          </q-card-section>
        </q-card>
      </div>
    </div>

    <!-- ÏÑ§Î¨∏ ÏÉÅÏÑ∏Î≥¥Í∏∞ Îã§Ïù¥ÏñºÎ°úÍ∑∏ -->
    <q-dialog v-model="showDetailDialog" maximized>
      <q-card>
        <q-card-section class="bg-primary text-white">
          <div class="text-h6">üìã ÏÑ§Î¨∏ ÏÉÅÏÑ∏Î≥¥Í∏∞</div>
        </q-card-section>
        <q-card-section v-if="selectedSurvey">
          <div class="row q-col-gutter-md">
            <div class="col-12">
              <h6>1. Í∞ïÏùò ÎßåÏ°±ÎèÑ</h6>
              <q-chip
                :color="getSatisfactionColor(selectedSurvey.satisfaction)"
                text-color="white"
                size="md"
              >
                {{ getSatisfactionLabel(selectedSurvey.satisfaction) }}
              </q-chip>
            </div>
            <div class="col-12">
              <h6>2. ÏßÄÏù∏ Ï∂îÏ≤ú ÏùòÌñ•</h6>
              <q-chip
                :color="getRecommendationColor(selectedSurvey.recommendation)"
                text-color="white"
                size="md"
              >
                {{ getRecommendationLabel(selectedSurvey.recommendation) }}
              </q-chip>
            </div>
            <div class="col-12">
              <h6>3. Ï∂îÍ∞Ä ÍµêÏú° ÏùòÌñ•</h6>
              <q-chip
                :color="getEducationColor(selectedSurvey.additionalEducation)"
                text-color="white"
                size="md"
              >
                {{ getEducationLabel(selectedSurvey.additionalEducation) }}
              </q-chip>
            </div>
            <div class="col-12">
              <h6>4. ÏûêÏú† ÏùòÍ≤¨</h6>
              <q-card flat bordered class="q-pa-md">
                <div v-if="selectedSurvey.feedback" class="text-body1">
                  {{ selectedSurvey.feedback }}
                </div>
                <div v-else class="text-grey-5">ÏùòÍ≤¨Ïù¥ ÏóÜÏäµÎãàÎã§.</div>
              </q-card>
            </div>
            <div class="col-12">
              <h6>Ï†úÏ∂ú Ï†ïÎ≥¥</h6>
              <div class="text-caption text-grey-7">
                Ï†úÏ∂úÏùº: {{ formatDate(selectedSurvey.submittedAt) }}
              </div>
              <div class="text-caption text-grey-7">ÏÑ§Î¨∏ ID: {{ selectedSurvey.id }}</div>
            </div>
          </div>
        </q-card-section>
        <q-card-actions align="right">
          <q-btn flat label="Îã´Í∏∞" @click="showDetailDialog = false" />
        </q-card-actions>
      </q-card>
    </q-dialog>
  </q-page>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useQuasar } from 'quasar';
import { surveyApiService } from '../services/surveyApiService';
import { SATISFACTION_OPTIONS, RECOMMENDATION_OPTIONS, EDUCATION_OPTIONS } from '../types/survey';

const $q = useQuasar();

// ÏÉÅÌÉú
const loading = ref(false);
const surveyResults = ref<any[]>([]);
const statistics = ref<any>({
  total: 0,
  satisfaction: {},
  recommendation: {},
  additionalEducation: {},
  averageFeedbackLength: 0,
});
const showDetailDialog = ref(false);
const selectedSurvey = ref<any>(null);

// ÌÖåÏù¥Î∏î Ïª¨Îüº Ï†ïÏùò
const columns = [
  {
    name: 'satisfaction',
    label: 'ÎßåÏ°±ÎèÑ',
    field: 'satisfaction',
    align: 'left' as const,
  },
  {
    name: 'recommendation',
    label: 'Ï∂îÏ≤ú ÏùòÌñ•',
    field: 'recommendation',
    align: 'left' as const,
  },
  {
    name: 'additionalEducation',
    label: 'Ï∂îÍ∞Ä ÍµêÏú° ÏùòÌñ•',
    field: 'additionalEducation',
    align: 'left' as const,
  },
  {
    name: 'feedback',
    label: 'ÌîºÎìúÎ∞±',
    field: 'feedback',
    align: 'left' as const,
  },
  {
    name: 'submittedAt',
    label: 'Ï†úÏ∂úÏùº',
    field: 'submittedAt',
    align: 'left' as const,
  },
  {
    name: 'actions',
    label: 'ÏÉÅÏÑ∏Î≥¥Í∏∞',
    field: 'actions',
    align: 'center' as const,
  },
];

// Í≥ÑÏÇ∞Îêú ÏÜçÏÑ±
const totalSurveys = computed(() => statistics.value.total || 1);

const averageSatisfaction = computed(() => {
  const satisfaction = statistics.value.satisfaction;
  if (!satisfaction || Object.keys(satisfaction).length === 0) return 0;

  let total = 0;
  let count = 0;

  Object.entries(satisfaction).forEach(([key, value]) => {
    const score = getSatisfactionScore(key);
    total += score * (value as number);
    count += value as number;
  });

  return count > 0 ? Math.round((total / count) * 20) : 0; // 5Ï†ê ÎßåÏ†êÏùÑ 100Ï†êÏúºÎ°ú Î≥ÄÌôò
});

const averageRecommendation = computed(() => {
  const recommendation = statistics.value.recommendation;
  if (!recommendation || Object.keys(recommendation).length === 0) return 0;

  let total = 0;
  let count = 0;

  Object.entries(recommendation).forEach(([key, value]) => {
    const score = getRecommendationScore(key);
    total += score * (value as number);
    count += value as number;
  });

  return count > 0 ? Math.round((total / count) * 20) : 0; // 5Ï†ê ÎßåÏ†êÏùÑ 100Ï†êÏúºÎ°ú Î≥ÄÌôò
});

// Î©îÏÑúÎìú
const loadSurveyResults = async () => {
  loading.value = true;

  try {
    // ÏÑ§Î¨∏ Í≤∞Í≥º Ï°∞Ìöå
    const resultsResponse = await surveyApiService.getSurveyResults();
    if (resultsResponse.success && resultsResponse.data) {
      surveyResults.value = resultsResponse.data;
    }

    // ÏÑ§Î¨∏ ÌÜµÍ≥Ñ Ï°∞Ìöå
    const statsResponse = await surveyApiService.getSurveyStatistics();
    if (statsResponse.success && statsResponse.statistics) {
      statistics.value = statsResponse.statistics;
    }
  } catch (error) {
    console.error('ÏÑ§Î¨∏ Í≤∞Í≥º Î°úÎìú Ïã§Ìå®:', error);
    $q.notify({
      type: 'negative',
      message: 'ÏÑ§Î¨∏ Í≤∞Í≥ºÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.',
      position: 'top',
    });
  } finally {
    loading.value = false;
  }
};

const showSurveyDetail = (survey: any) => {
  selectedSurvey.value = survey;
  showDetailDialog.value = true;
};

const formatDate = (dateString: string): string => {
  const date = new Date(dateString);
  return date.toLocaleDateString('ko-KR', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
};

// ÎùºÎ≤® Î≥ÄÌôò Ìï®ÏàòÎì§
const getSatisfactionLabel = (value: string | number): string => {
  const option = SATISFACTION_OPTIONS.find((opt) => opt.value === String(value));
  return option ? option.label : String(value);
};

const getRecommendationLabel = (value: string | number): string => {
  const option = RECOMMENDATION_OPTIONS.find((opt) => opt.value === String(value));
  return option ? option.label : String(value);
};

const getEducationLabel = (value: string | number): string => {
  const option = EDUCATION_OPTIONS.find((opt) => opt.value === String(value));
  return option ? option.label : String(value);
};

// ÏÉâÏÉÅ Î≥ÄÌôò Ìï®ÏàòÎì§
const getSatisfactionColor = (value: string | number): string => {
  const colorMap: { [key: string]: string } = {
    very_satisfied: 'positive',
    satisfied: 'positive',
    neutral: 'warning',
    dissatisfied: 'negative',
    very_dissatisfied: 'negative',
  };
  return colorMap[String(value)] || 'grey';
};

const getRecommendationColor = (value: string | number): string => {
  const colorMap: { [key: string]: string } = {
    highly_recommend: 'positive',
    recommend: 'positive',
    neutral: 'warning',
    not_recommend: 'negative',
    highly_not_recommend: 'negative',
  };
  return colorMap[String(value)] || 'grey';
};

const getEducationColor = (value: string | number): string => {
  const colorMap: { [key: string]: string } = {
    very_interested: 'positive',
    interested: 'positive',
    neutral: 'warning',
    not_interested: 'negative',
    not_at_all_interested: 'negative',
  };
  return colorMap[String(value)] || 'grey';
};

// Ï†êÏàò Î≥ÄÌôò Ìï®ÏàòÎì§
const getSatisfactionScore = (value: string | number): number => {
  const scoreMap: { [key: string]: number } = {
    very_satisfied: 5,
    satisfied: 4,
    neutral: 3,
    dissatisfied: 2,
    very_dissatisfied: 1,
  };
  return scoreMap[String(value)] || 0;
};

const getRecommendationScore = (value: string | number): number => {
  const scoreMap: { [key: string]: number } = {
    highly_recommend: 5,
    recommend: 4,
    neutral: 3,
    not_recommend: 2,
    highly_not_recommend: 1,
  };
  return scoreMap[String(value)] || 0;
};

// Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
onMounted(() => {
  loadSurveyResults();
});
</script>
